# ESP32 MicroPython 代码上传完整指南

## 📋 目录
- [前置准备](#前置准备)
- [固件烧录](#固件烧录)
- [代码上传方法](#代码上传方法)
- [文件管理](#文件管理)
- [常见问题](#常见问题)
- [最佳实践](#最佳实践)

## 🔧 前置准备

### 1. 安装必要工具
```bash
# 安装 Python 3 (如果未安装)
# macOS: brew install python3
# Ubuntu: sudo apt install python3 python3-pip

# 安装 esptool (用于固件烧录)
pip3 install esptool

# 安装代码上传工具 (选择其一)
pip3 install adafruit-ampy    # ampy 工具
pip3 install mpremote         # mpremote 工具
```

### 2. 识别设备端口
```bash
# macOS
ls /dev/tty.usbserial-* /dev/tty.SLAB_USBtoUART /dev/tty.usbmodem*

# Linux
ls /dev/ttyUSB* /dev/ttyACM*

# Windows (在命令提示符中)
mode
```

### 3. 确认芯片型号
```bash
python3 -m esptool chip_id
```

## 🔥 固件烧录

### 使用自动化脚本 (推荐)
```bash
# ESP32 经典款
./flash_esp32.sh [端口号]

# ESP32-S3
./flash_esp32s3.sh [端口号]
```

### 手动烧录命令

#### ESP32 经典款
```bash
# 1. 擦除闪存
python3 -m esptool --chip esp32 --port /dev/tty.usbserial-xxxx erase_flash

# 2. 烧录固件
python3 -m esptool --chip esp32 --port /dev/tty.usbserial-xxxx write_flash -z 0x1000 esp32/esp32-micropython.bin
```

#### ESP32-S3
```bash
# 1. 擦除闪存
python3 -m esptool --chip esp32s3 --port /dev/tty.usbserial-xxxx erase_flash

# 2. 烧录固件 (注意地址是 0x0)
python3 -m esptool --chip esp32s3 --port /dev/tty.usbserial-xxxx write_flash -z 0x0 esp32s3/esp32s3-micropython.bin
```

#### ESP32-C3
```bash
# 1. 擦除闪存
python3 -m esptool --chip esp32c3 --port /dev/tty.usbserial-xxxx erase_flash

# 2. 烧录固件
python3 -m esptool --chip esp32c3 --port /dev/tty.usbserial-xxxx write_flash -z 0x0 esp32c3/esp32c3-micropython.bin
```

## 💻 代码上传方法

### 方法一：Thonny IDE (最适合初学者)

1. **安装 Thonny**
   - 下载：https://thonny.org/
   - 支持 Windows、macOS、Linux

2. **配置连接**
   - 工具 → 选项 → 解释器
   - 选择 "MicroPython (ESP32)"
   - 设置正确的端口和波特率 (115200)

3. **上传代码**
   - 在编辑器中编写代码
   - 点击 "运行" 按钮直接执行
   - 文件 → 另存为 → 选择 "MicroPython 设备" 保存到设备

4. **文件管理**
   - 查看 → 文件 → 显示文件面板
   - 可以直接拖拽文件到设备

### 方法二：ampy 工具 (命令行)

```bash
# 设置端口变量 (方便使用)
export AMPY_PORT=/dev/tty.usbserial-xxxx

# 上传单个文件
ampy put main.py

# 上传并重命名
ampy put local_file.py remote_file.py

# 上传整个目录
ampy put src/ /

# 列出设备文件
ampy ls

# 查看文件内容
ampy get main.py

# 删除文件
ampy rm main.py

# 创建目录
ampy mkdir lib

# 运行文件
ampy run test.py
```

### 方法三：mpremote 工具 (官方推荐)

```bash
# 连接设备
mpremote connect /dev/tty.usbserial-xxxx

# 上传文件
mpremote connect /dev/tty.usbserial-xxxx cp main.py :

# 上传到指定目录
mpremote connect /dev/tty.usbserial-xxxx cp main.py :/lib/

# 下载文件
mpremote connect /dev/tty.usbserial-xxxx cp :main.py .

# 列出文件
mpremote connect /dev/tty.usbserial-xxxx ls

# 执行文件
mpremote connect /dev/tty.usbserial-xxxx exec "exec(open('main.py').read())"

# 进入 REPL
mpremote connect /dev/tty.usbserial-xxxx repl
```

### 方法四：串口终端 (直接输入)

```bash
# 连接到设备
screen /dev/tty.usbserial-xxxx 115200

# 或使用 minicom (Linux)
minicom -D /dev/tty.usbserial-xxxx -b 115200

# 在 REPL 中直接输入代码
>>> print("Hello ESP32!")
>>> import machine
>>> led = machine.Pin(2, machine.Pin.OUT)
>>> led.on()
```

### 方法五：VS Code + Pymakr 插件

1. **安装插件**
   - 在 VS Code 中搜索并安装 "Pymakr" 插件

2. **配置项目**
   - 创建 `pymakr.conf` 文件
   ```json
   {
       "address": "/dev/tty.usbserial-xxxx",
       "username": "micro",
       "password": "python",
       "sync_folder": "",
       "open_on_start": true
   }
   ```

3. **同步代码**
   - Ctrl+Shift+P → "Pymakr: Upload project"

## 📁 文件管理

### 重要文件说明
- `boot.py` - 设备启动时自动执行，用于初始化设置
- `main.py` - boot.py 执行后自动运行，主程序入口
- `lib/` - 自定义模块目录
- `config.py` - 配置文件 (自定义)

### 典型项目结构
```
ESP32 设备文件系统/
├── boot.py          # 启动配置
├── main.py          # 主程序
├── config.py        # 配置文件
├── lib/             # 库文件目录
│   ├── sensor.py    # 传感器模块
│   └── wifi_manager.py  # WiFi 管理模块
└── data/            # 数据文件目录
    └── settings.json
```

### 示例 boot.py
```python
# boot.py -- 在启动时运行
import esp
import gc
import webrepl

# 禁用调试信息
esp.osdebug(None)

# 启动垃圾回收
gc.collect()

# 启动 WebREPL (可选)
webrepl.start()

print("Boot completed")
```

### 示例 main.py
```python
# main.py -- 主程序
import machine
import time

# 初始化 LED
led = machine.Pin(2, machine.Pin.OUT)

# 主循环
while True:
    led.on()
    time.sleep(0.5)
    led.off()
    time.sleep(0.5)
```

## ❗ 常见问题

### 1. 端口连接问题
```bash
# 错误：Permission denied
sudo chmod 666 /dev/tty.usbserial-xxxx

# 或将用户添加到 dialout 组 (Linux)
sudo usermod -a -G dialout $USER
# 需要重新登录生效
```

### 2. 设备无响应
- 按住 BOOT 按钮，然后按 RST 按钮进入下载模式
- 检查 USB 线是否支持数据传输
- 尝试不同的 USB 端口

### 3. 固件烧录失败
```bash
# 手动进入下载模式
# 1. 按住 BOOT 按钮
# 2. 按一下 RST 按钮
# 3. 松开 RST 按钮
# 4. 松开 BOOT 按钮
# 5. 重新执行烧录命令
```

### 4. 代码上传失败
- 确认设备已正确烧录 MicroPython 固件
- 检查端口号是否正确
- 尝试重启设备
- 检查文件路径和权限

### 5. 内存不足
```python
# 在代码中添加垃圾回收
import gc
gc.collect()

# 查看内存使用情况
import micropython
micropython.mem_info()
```

## 🎯 最佳实践

### 1. 代码组织
- 将复杂功能拆分为独立模块
- 使用 `lib/` 目录存放自定义模块
- 保持 `main.py` 简洁，主要用于调用其他模块

### 2. 错误处理
```python
try:
    # 可能出错的代码
    import wifi_manager
    wifi_manager.connect()
except Exception as e:
    print(f"Error: {e}")
    # 错误处理逻辑
```

### 3. 资源管理
```python
# 及时释放资源
import gc

def heavy_function():
    # 执行内存密集操作
    result = process_data()
    gc.collect()  # 手动垃圾回收
    return result
```

### 4. 调试技巧
```python
# 使用 print 调试
print(f"Variable value: {variable}")

# 使用异常捕获
try:
    risky_operation()
except Exception as e:
    print(f"Debug: {type(e).__name__}: {e}")
```

### 5. 版本控制
- 在本地使用 Git 管理代码
- 定期备份设备上的重要文件
- 使用有意义的文件名和注释

### 6. 性能优化
- 避免在循环中创建大量对象
- 使用生成器而不是列表 (节省内存)
- 合理使用 `time.sleep()` 避免 CPU 占用过高

## 🔗 相关资源

- [MicroPython 官方文档](https://docs.micropython.org/)
- [ESP32 MicroPython 教程](https://docs.micropython.org/en/latest/esp32/tutorial/index.html)
- [Thonny IDE 官网](https://thonny.org/)
- [esptool 文档](https://docs.espressif.com/projects/esptool/en/latest/)

---

*最后更新：2025-09-14*
