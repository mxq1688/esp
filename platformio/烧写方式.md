# PlatformIO 代码烧写方式完整指南

## 📋 目录
- [准备工作](#准备工作)
- [方法一：命令行烧写](#方法一命令行烧写)
- [方法二：VS Code 图形界面](#方法二vs-code-图形界面)
- [方法三：自定义配置烧写](#方法三自定义配置烧写)
- [烧写过程详解](#烧写过程详解)
- [常见问题解决](#常见问题解决)
- [高级技巧](#高级技巧)

## 🔧 准备工作

### 硬件连接
1. **USB 数据线连接**
   - 使用支持数据传输的 USB 线（不是仅充电线）
   - 连接 ESP32 到电脑的 USB 端口
   - 确保 ESP32 上电，指示灯亮起

2. **驱动程序安装**
   ```bash
   # 检查设备是否被识别
   pio device list
   ```

3. **项目结构检查**
   ```
   platformio/
   ├── platformio.ini    # 配置文件
   ├── src/             # 源代码目录
   │   └── main.cpp
   ├── lib/             # 库文件目录
   └── .pio/            # 构建输出目录
   ```

## 🚀 方法一：命令行烧写

### 基本命令
```bash
# 进入项目目录
cd platformio

# 1. 仅编译代码
pio run

# 2. 编译并上传
pio run --target upload
# 或简写
pio run -t upload

# 3. 上传并监控串口
pio run -t upload -t monitor

# 4. 清理构建文件
pio run -t clean
```

### 指定端口上传
```bash
# 自动检测端口
pio device list

# 手动指定端口
pio run -t upload --upload-port /dev/cu.usbserial-xxx  # macOS
pio run -t upload --upload-port COM3                   # Windows
pio run -t upload --upload-port /dev/ttyUSB0           # Linux
```

### 详细输出模式
```bash
# 显示详细编译信息
pio run -v

# 显示详细上传信息
pio run -t upload -v
```

## 🖥️ 方法二：VS Code 图形界面

### PlatformIO 插件按钮
在 VS Code 底部状态栏：
- `✓` **Build** - 编译项目
- `→` **Upload** - 上传代码
- `🔌` **Upload and Monitor** - 上传并监控
- `📺` **Serial Monitor** - 串口监控
- `[object Object]清理构建

### 命令面板操作
1. 按 `Ctrl/Cmd + Shift + P` 打开命令面板
2. 输入以下命令：
   - `PlatformIO: Build` - 编译
   - `PlatformIO: Upload` - 上传
   - `PlatformIO: Upload and Monitor` - 上传并监控
   - `PlatformIO: Serial Monitor` - 串口监控

### 快捷键设置
```json
// settings.json 中添加快捷键
{
  "key": "ctrl+alt+u",
  "command": "platformio-ide.upload"
}
```

## ⚙️ 方法三：自定义配置烧写

### platformio.ini 配置示例
```ini
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino

; 上传配置
upload_protocol = esptool
upload_speed = 921600
upload_port = /dev/cu.usbserial-*

; 监控配置
monitor_speed = 115200
monitor_port = /dev/cu.usbserial-*
monitor_filters = 
    esp32_exception_decoder
    time

; 编译选项
build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM

; OTA 无线更新配置
upload_protocol = espota
upload_port = 192.168.1.100
upload_flags = 
    --port=3232
    --auth=mypassword
```

### 多环境配置
```ini
; 开发环境
[env:dev]
platform = espressif32
board = esp32dev
framework = arduino
upload_speed = 115200
build_type = debug

; 生产环境
[env:prod]
platform = espressif32
board = esp32dev
framework = arduino
upload_speed = 921600
build_type = release
build_flags = -O2

; 指定环境上传
; pio run -e dev -t upload
; pio run -e prod -t upload
```

## 🔍 烧写过程详解

### 完整烧写流程
1. **代码编译**
   ```
   Compiling .pio/build/esp32dev/src/main.cpp.o
   Linking .pio/build/esp32dev/firmware.elf
   Building .pio/build/esp32dev/firmware.bin
   ```

2. **设备检测**
   ```
   Looking for upload port...
   Auto-detected: /dev/cu.usbserial-0001
   ```

3. **固件上传**
   ```
   esptool.py v4.9.0
   Chip is ESP32-D0WDQ6 (revision v1.0)
   Uploading stub...
   Configuring flash size...
   ```

4. **分区写入**
   ```
   Writing at 0x00001000... (Bootloader)
   Writing at 0x00008000... (Partition table)
   Writing at 0x00010000... (Application)
   ```

5. **验证重启**
   ```
   Hash of data verified.
   Hard resetting via RTS pin...
   ```

### 内存使用分析
```
RAM:   [=         ]   6.6% (used 21536 bytes from 327680 bytes)
Flash: [==        ]  21.5% (used 281429 bytes from 1310720 bytes)
```

## 🚨 常见问题解决

### 问题1：找不到设备
**错误信息**：
```
Error: Please specify `upload_port` for environment
```

**解决方案**：
```bash
# 1. 检查设备连接
pio device list

# 2. 手动指定端口
pio run -t upload --upload-port /dev/cu.usbserial-xxx

# 3. 在 platformio.ini 中配置
upload_port = /dev/cu.usbserial-*
```

### 问题2：权限被拒绝 (Linux/Mac)
**错误信息**：
```
Permission denied: '/dev/ttyUSB0'
```

**解决方案**：
```bash
# 添加用户到 dialout 组
sudo usermod -a -G dialout $USER

# 或临时修改权限
sudo chmod 666 /dev/ttyUSB0

# 重新登录使权限生效
```

### 问题3：上传失败/超时
**错误信息**：
```
Failed to connect to ESP32: Timed out waiting for packet header
```

**解决方案**：
```ini
; 降低上传速度
upload_speed = 115200

; 或添加重置配置
upload_resetmethod = hard_reset
```

**手动操作**：
- 在上传时按住 ESP32 的 `BOOT` 按钮
- 看到 "Connecting..." 时松开按钮

### 问题4：串口被占用
**错误信息**：
```
Serial port /dev/cu.usbserial-xxx is busy
```

**解决方案**：
```bash
# 关闭其他串口监控程序
# 或强制结束进程
sudo lsof | grep usbserial
sudo kill -9 <PID>
```

### 问题5：固件太大
**错误信息**：
```
Sketch too big; see http://www.arduino.cc/en/Guide/Troubleshooting#size
```

**解决方案**：
```ini
; 启用分区优化
board_build.partitions = huge_app.csv

; 或使用自定义分区表
board_build.partitions = custom_partitions.csv
```

## 🎯 高级技巧

### 1. 批量上传
```bash
# 上传到多个设备
for port in /dev/cu.usbserial-*; do
    pio run -t upload --upload-port $port
done
```

### 2. 自动化脚本
```bash
#!/bin/bash
# upload.sh
echo "开始编译..."
pio run
if [ $? -eq 0 ]; then
    echo "编译成功，开始上传..."
    pio run -t upload
    if [ $? -eq 0 ]; then
        echo "上传成功，启动监控..."
        pio device monitor
    fi
fi
```

### 3. 条件编译
```cpp
// main.cpp
#ifdef DEBUG_MODE
    Serial.println("Debug mode enabled");
#endif
```

```ini
; platformio.ini
[env:debug]
build_flags = -DDEBUG_MODE

[env:release]
build_flags = -DRELEASE_MODE
```

### 4. OTA 无线更新
```ini
; 启用 OTA
[env:ota]
upload_protocol = espota
upload_port = esp32.local
upload_flags = --auth=password
```

### 5. 自定义上传脚本
```python
# extra_script.py
Import("env")

def before_upload(source, target, env):
    print("准备上传固件...")
    # 自定义逻辑

env.AddPreAction("upload", before_upload)
```

```ini
; platformio.ini
extra_scripts = extra_script.py
```

## 📊 性能优化

### 编译优化
```ini
build_flags = 
    -O2                    ; 优化级别
    -DCORE_DEBUG_LEVEL=0   ; 关闭调试
    -ffunction-sections    ; 函数分段
    -fdata-sections        ; 数据分段
```

### 上传速度优化
```ini
; 最快上传速度（可能不稳定）
upload_speed = 921600

; 稳定上传速度
upload_speed = 460800

; 保守上传速度
upload_speed = 115200
```

## 🔗 相关命令参考

```bash
# 项目管理
pio project init --board esp32dev        # 初始化项目
pio project config                        # 查看配置

# 设备管理
pio device list                          # 列出设备
pio device monitor                       # 串口监控
pio device monitor --port COM3          # 指定端口监控

# 库管理
pio lib search wifi                      # 搜索库
pio lib install "WiFi"                   # 安装库

# 平台管理
pio platform list                       # 列出平台
pio platform install espressif32       # 安装平台

# 清理和重置
pio run -t clean                         # 清理构建
pio system prune                         # 清理缓存
```

---

## 📝 总结

PlatformIO 提供了多种灵活的代码烧写方式：

1. **命令行方式** - 适合自动化和脚本
2. **图形界面** - 适合日常开发
3. **自定义配置** - 适合复杂项目

选择合适的方式可以大大提高开发效率。遇到问题时，检查硬件连接、驱动程序和配置文件通常能解决大部分问题。

**快速开始**：
```bash
cd your_project
pio run -t upload -t monitor
```

祝您开发愉快！🚀
