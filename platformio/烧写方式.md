# PlatformIO ä»£ç çƒ§å†™æ–¹å¼å®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•
- [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
- [æ–¹æ³•ä¸€ï¼šå‘½ä»¤è¡Œçƒ§å†™](#æ–¹æ³•ä¸€å‘½ä»¤è¡Œçƒ§å†™)
- [æ–¹æ³•äºŒï¼šVS Code å›¾å½¢ç•Œé¢](#æ–¹æ³•äºŒvs-code-å›¾å½¢ç•Œé¢)
- [æ–¹æ³•ä¸‰ï¼šè‡ªå®šä¹‰é…ç½®çƒ§å†™](#æ–¹æ³•ä¸‰è‡ªå®šä¹‰é…ç½®çƒ§å†™)
- [çƒ§å†™è¿‡ç¨‹è¯¦è§£](#çƒ§å†™è¿‡ç¨‹è¯¦è§£)
- [å¸¸è§é—®é¢˜è§£å†³](#å¸¸è§é—®é¢˜è§£å†³)
- [é«˜çº§æŠ€å·§](#é«˜çº§æŠ€å·§)

## ğŸ”§ å‡†å¤‡å·¥ä½œ

### ç¡¬ä»¶è¿æ¥
1. **USB æ•°æ®çº¿è¿æ¥**
   - ä½¿ç”¨æ”¯æŒæ•°æ®ä¼ è¾“çš„ USB çº¿ï¼ˆä¸æ˜¯ä»…å……ç”µçº¿ï¼‰
   - è¿æ¥ ESP32 åˆ°ç”µè„‘çš„ USB ç«¯å£
   - ç¡®ä¿ ESP32 ä¸Šç”µï¼ŒæŒ‡ç¤ºç¯äº®èµ·

2. **é©±åŠ¨ç¨‹åºå®‰è£…**
   ```bash
   # æ£€æŸ¥è®¾å¤‡æ˜¯å¦è¢«è¯†åˆ«
   pio device list
   ```

3. **é¡¹ç›®ç»“æ„æ£€æŸ¥**
   ```
   platformio/
   â”œâ”€â”€ platformio.ini    # é…ç½®æ–‡ä»¶
   â”œâ”€â”€ src/             # æºä»£ç ç›®å½•
   â”‚   â””â”€â”€ main.cpp
   â”œâ”€â”€ lib/             # åº“æ–‡ä»¶ç›®å½•
   â””â”€â”€ .pio/            # æ„å»ºè¾“å‡ºç›®å½•
   ```

## ğŸš€ æ–¹æ³•ä¸€ï¼šå‘½ä»¤è¡Œçƒ§å†™

### åŸºæœ¬å‘½ä»¤
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd platformio

# 1. ä»…ç¼–è¯‘ä»£ç 
pio run

# 2. ç¼–è¯‘å¹¶ä¸Šä¼ 
pio run --target upload
# æˆ–ç®€å†™
pio run -t upload

# 3. ä¸Šä¼ å¹¶ç›‘æ§ä¸²å£
pio run -t upload -t monitor

# 4. æ¸…ç†æ„å»ºæ–‡ä»¶
pio run -t clean
```

### æŒ‡å®šç«¯å£ä¸Šä¼ 
```bash
# è‡ªåŠ¨æ£€æµ‹ç«¯å£
pio device list

# æ‰‹åŠ¨æŒ‡å®šç«¯å£
pio run -t upload --upload-port /dev/cu.usbserial-xxx  # macOS
pio run -t upload --upload-port COM3                   # Windows
pio run -t upload --upload-port /dev/ttyUSB0           # Linux
```

### è¯¦ç»†è¾“å‡ºæ¨¡å¼
```bash
# æ˜¾ç¤ºè¯¦ç»†ç¼–è¯‘ä¿¡æ¯
pio run -v

# æ˜¾ç¤ºè¯¦ç»†ä¸Šä¼ ä¿¡æ¯
pio run -t upload -v
```

## ğŸ–¥ï¸ æ–¹æ³•äºŒï¼šVS Code å›¾å½¢ç•Œé¢

### PlatformIO æ’ä»¶æŒ‰é’®
åœ¨ VS Code åº•éƒ¨çŠ¶æ€æ ï¼š
- `âœ“` **Build** - ç¼–è¯‘é¡¹ç›®
- `â†’` **Upload** - ä¸Šä¼ ä»£ç 
- `ğŸ”Œ` **Upload and Monitor** - ä¸Šä¼ å¹¶ç›‘æ§
- `ğŸ“º` **Serial Monitor** - ä¸²å£ç›‘æ§
- `[object Object]æ¸…ç†æ„å»º

### å‘½ä»¤é¢æ¿æ“ä½œ
1. æŒ‰ `Ctrl/Cmd + Shift + P` æ‰“å¼€å‘½ä»¤é¢æ¿
2. è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š
   - `PlatformIO: Build` - ç¼–è¯‘
   - `PlatformIO: Upload` - ä¸Šä¼ 
   - `PlatformIO: Upload and Monitor` - ä¸Šä¼ å¹¶ç›‘æ§
   - `PlatformIO: Serial Monitor` - ä¸²å£ç›‘æ§

### å¿«æ·é”®è®¾ç½®
```json
// settings.json ä¸­æ·»åŠ å¿«æ·é”®
{
  "key": "ctrl+alt+u",
  "command": "platformio-ide.upload"
}
```

## âš™ï¸ æ–¹æ³•ä¸‰ï¼šè‡ªå®šä¹‰é…ç½®çƒ§å†™

### platformio.ini é…ç½®ç¤ºä¾‹
```ini
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino

; ä¸Šä¼ é…ç½®
upload_protocol = esptool
upload_speed = 921600
upload_port = /dev/cu.usbserial-*

; ç›‘æ§é…ç½®
monitor_speed = 115200
monitor_port = /dev/cu.usbserial-*
monitor_filters = 
    esp32_exception_decoder
    time

; ç¼–è¯‘é€‰é¡¹
build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM

; OTA æ— çº¿æ›´æ–°é…ç½®
upload_protocol = espota
upload_port = 192.168.1.100
upload_flags = 
    --port=3232
    --auth=mypassword
```

### å¤šç¯å¢ƒé…ç½®
```ini
; å¼€å‘ç¯å¢ƒ
[env:dev]
platform = espressif32
board = esp32dev
framework = arduino
upload_speed = 115200
build_type = debug

; ç”Ÿäº§ç¯å¢ƒ
[env:prod]
platform = espressif32
board = esp32dev
framework = arduino
upload_speed = 921600
build_type = release
build_flags = -O2

; æŒ‡å®šç¯å¢ƒä¸Šä¼ 
; pio run -e dev -t upload
; pio run -e prod -t upload
```

## ğŸ” çƒ§å†™è¿‡ç¨‹è¯¦è§£

### å®Œæ•´çƒ§å†™æµç¨‹
1. **ä»£ç ç¼–è¯‘**
   ```
   Compiling .pio/build/esp32dev/src/main.cpp.o
   Linking .pio/build/esp32dev/firmware.elf
   Building .pio/build/esp32dev/firmware.bin
   ```

2. **è®¾å¤‡æ£€æµ‹**
   ```
   Looking for upload port...
   Auto-detected: /dev/cu.usbserial-0001
   ```

3. **å›ºä»¶ä¸Šä¼ **
   ```
   esptool.py v4.9.0
   Chip is ESP32-D0WDQ6 (revision v1.0)
   Uploading stub...
   Configuring flash size...
   ```

4. **åˆ†åŒºå†™å…¥**
   ```
   Writing at 0x00001000... (Bootloader)
   Writing at 0x00008000... (Partition table)
   Writing at 0x00010000... (Application)
   ```

5. **éªŒè¯é‡å¯**
   ```
   Hash of data verified.
   Hard resetting via RTS pin...
   ```

### å†…å­˜ä½¿ç”¨åˆ†æ
```
RAM:   [=         ]   6.6% (used 21536 bytes from 327680 bytes)
Flash: [==        ]  21.5% (used 281429 bytes from 1310720 bytes)
```

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1ï¼šæ‰¾ä¸åˆ°è®¾å¤‡
**é”™è¯¯ä¿¡æ¯**ï¼š
```
Error: Please specify `upload_port` for environment
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥è®¾å¤‡è¿æ¥
pio device list

# 2. æ‰‹åŠ¨æŒ‡å®šç«¯å£
pio run -t upload --upload-port /dev/cu.usbserial-xxx

# 3. åœ¨ platformio.ini ä¸­é…ç½®
upload_port = /dev/cu.usbserial-*
```

### é—®é¢˜2ï¼šæƒé™è¢«æ‹’ç» (Linux/Mac)
**é”™è¯¯ä¿¡æ¯**ï¼š
```
Permission denied: '/dev/ttyUSB0'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ·»åŠ ç”¨æˆ·åˆ° dialout ç»„
sudo usermod -a -G dialout $USER

# æˆ–ä¸´æ—¶ä¿®æ”¹æƒé™
sudo chmod 666 /dev/ttyUSB0

# é‡æ–°ç™»å½•ä½¿æƒé™ç”Ÿæ•ˆ
```

### é—®é¢˜3ï¼šä¸Šä¼ å¤±è´¥/è¶…æ—¶
**é”™è¯¯ä¿¡æ¯**ï¼š
```
Failed to connect to ESP32: Timed out waiting for packet header
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```ini
; é™ä½ä¸Šä¼ é€Ÿåº¦
upload_speed = 115200

; æˆ–æ·»åŠ é‡ç½®é…ç½®
upload_resetmethod = hard_reset
```

**æ‰‹åŠ¨æ“ä½œ**ï¼š
- åœ¨ä¸Šä¼ æ—¶æŒ‰ä½ ESP32 çš„ `BOOT` æŒ‰é’®
- çœ‹åˆ° "Connecting..." æ—¶æ¾å¼€æŒ‰é’®

### é—®é¢˜4ï¼šä¸²å£è¢«å ç”¨
**é”™è¯¯ä¿¡æ¯**ï¼š
```
Serial port /dev/cu.usbserial-xxx is busy
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å…³é—­å…¶ä»–ä¸²å£ç›‘æ§ç¨‹åº
# æˆ–å¼ºåˆ¶ç»“æŸè¿›ç¨‹
sudo lsof | grep usbserial
sudo kill -9 <PID>
```

### é—®é¢˜5ï¼šå›ºä»¶å¤ªå¤§
**é”™è¯¯ä¿¡æ¯**ï¼š
```
Sketch too big; see http://www.arduino.cc/en/Guide/Troubleshooting#size
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```ini
; å¯ç”¨åˆ†åŒºä¼˜åŒ–
board_build.partitions = huge_app.csv

; æˆ–ä½¿ç”¨è‡ªå®šä¹‰åˆ†åŒºè¡¨
board_build.partitions = custom_partitions.csv
```

## ğŸ¯ é«˜çº§æŠ€å·§

### 1. æ‰¹é‡ä¸Šä¼ 
```bash
# ä¸Šä¼ åˆ°å¤šä¸ªè®¾å¤‡
for port in /dev/cu.usbserial-*; do
    pio run -t upload --upload-port $port
done
```

### 2. è‡ªåŠ¨åŒ–è„šæœ¬
```bash
#!/bin/bash
# upload.sh
echo "å¼€å§‹ç¼–è¯‘..."
pio run
if [ $? -eq 0 ]; then
    echo "ç¼–è¯‘æˆåŠŸï¼Œå¼€å§‹ä¸Šä¼ ..."
    pio run -t upload
    if [ $? -eq 0 ]; then
        echo "ä¸Šä¼ æˆåŠŸï¼Œå¯åŠ¨ç›‘æ§..."
        pio device monitor
    fi
fi
```

### 3. æ¡ä»¶ç¼–è¯‘
```cpp
// main.cpp
#ifdef DEBUG_MODE
    Serial.println("Debug mode enabled");
#endif
```

```ini
; platformio.ini
[env:debug]
build_flags = -DDEBUG_MODE

[env:release]
build_flags = -DRELEASE_MODE
```

### 4. OTA æ— çº¿æ›´æ–°
```ini
; å¯ç”¨ OTA
[env:ota]
upload_protocol = espota
upload_port = esp32.local
upload_flags = --auth=password
```

### 5. è‡ªå®šä¹‰ä¸Šä¼ è„šæœ¬
```python
# extra_script.py
Import("env")

def before_upload(source, target, env):
    print("å‡†å¤‡ä¸Šä¼ å›ºä»¶...")
    # è‡ªå®šä¹‰é€»è¾‘

env.AddPreAction("upload", before_upload)
```

```ini
; platformio.ini
extra_scripts = extra_script.py
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### ç¼–è¯‘ä¼˜åŒ–
```ini
build_flags = 
    -O2                    ; ä¼˜åŒ–çº§åˆ«
    -DCORE_DEBUG_LEVEL=0   ; å…³é—­è°ƒè¯•
    -ffunction-sections    ; å‡½æ•°åˆ†æ®µ
    -fdata-sections        ; æ•°æ®åˆ†æ®µ
```

### ä¸Šä¼ é€Ÿåº¦ä¼˜åŒ–
```ini
; æœ€å¿«ä¸Šä¼ é€Ÿåº¦ï¼ˆå¯èƒ½ä¸ç¨³å®šï¼‰
upload_speed = 921600

; ç¨³å®šä¸Šä¼ é€Ÿåº¦
upload_speed = 460800

; ä¿å®ˆä¸Šä¼ é€Ÿåº¦
upload_speed = 115200
```

## ğŸ”— ç›¸å…³å‘½ä»¤å‚è€ƒ

```bash
# é¡¹ç›®ç®¡ç†
pio project init --board esp32dev        # åˆå§‹åŒ–é¡¹ç›®
pio project config                        # æŸ¥çœ‹é…ç½®

# è®¾å¤‡ç®¡ç†
pio device list                          # åˆ—å‡ºè®¾å¤‡
pio device monitor                       # ä¸²å£ç›‘æ§
pio device monitor --port COM3          # æŒ‡å®šç«¯å£ç›‘æ§

# åº“ç®¡ç†
pio lib search wifi                      # æœç´¢åº“
pio lib install "WiFi"                   # å®‰è£…åº“

# å¹³å°ç®¡ç†
pio platform list                       # åˆ—å‡ºå¹³å°
pio platform install espressif32       # å®‰è£…å¹³å°

# æ¸…ç†å’Œé‡ç½®
pio run -t clean                         # æ¸…ç†æ„å»º
pio system prune                         # æ¸…ç†ç¼“å­˜
```

---

## ğŸ“ æ€»ç»“

PlatformIO æä¾›äº†å¤šç§çµæ´»çš„ä»£ç çƒ§å†™æ–¹å¼ï¼š

1. **å‘½ä»¤è¡Œæ–¹å¼** - é€‚åˆè‡ªåŠ¨åŒ–å’Œè„šæœ¬
2. **å›¾å½¢ç•Œé¢** - é€‚åˆæ—¥å¸¸å¼€å‘
3. **è‡ªå®šä¹‰é…ç½®** - é€‚åˆå¤æ‚é¡¹ç›®

é€‰æ‹©åˆé€‚çš„æ–¹å¼å¯ä»¥å¤§å¤§æé«˜å¼€å‘æ•ˆç‡ã€‚é‡åˆ°é—®é¢˜æ—¶ï¼Œæ£€æŸ¥ç¡¬ä»¶è¿æ¥ã€é©±åŠ¨ç¨‹åºå’Œé…ç½®æ–‡ä»¶é€šå¸¸èƒ½è§£å†³å¤§éƒ¨åˆ†é—®é¢˜ã€‚

**å¿«é€Ÿå¼€å§‹**ï¼š
```bash
cd your_project
pio run -t upload -t monitor
```

ç¥æ‚¨å¼€å‘æ„‰å¿«ï¼ğŸš€
